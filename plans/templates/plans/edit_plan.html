{% extends 'base.html' %}
{% load formset_utils %} {# <-- IMPORTANT: Load your custom template tags #}

{% block title %}Edit Plan: {{ plan_instance.id }}{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-4xl mx-auto">

        <h1 class="text-3xl font-extrabold text-indigo-700 mb-6 border-b pb-2">
            Edit Annual Plan #{{ plan_instance.id }} ({{ plan_instance.get_plan_type_display }})
        </h1>
        
        {% if form.non_field_errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline">Please correct the errors below.</span>
            </div>
        {% endif %}

        <form method="post" id="plan-form" action="{% url 'edit_plan' plan_instance.id %}">
            {% csrf_token %}
            
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 mt-6">1. Plan Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                {% for field in form %}
                    <div class="{% if field.field.widget.input_type == 'checkbox' %}col-span-2{% endif %}">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ field.errors|join:", " }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            ---
            
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 mt-6 flex justify-between items-center">
                2. Strategic Goals
                <button type="button" id="add-goal-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                    + Add Goal
                </button>
            </h2>
            
            {{ goal_formset.management_form }}
            <div id="goals-container" class="space-y-4 mb-8">
                {% for goal_form in goal_formset %}
                    <div class="goal-form form-row p-4 border rounded-lg bg-gray-50 shadow-sm {% if goal_form.instance.pk and goal_form.DELETE.value %}deleted-form{% endif %}" data-form-type="goal">
                        <h4 class="font-medium text-lg text-gray-700 mb-2">Goal #<span class="form-number">{{ forloop.counter }}</span></h4>
                        {{ goal_form.id }}
                        {{ goal_form.DELETE }}
                        <div class="flex items-center space-x-4">
                            <div class="flex-grow">
                                {{ goal_form.title.label_tag }}
                                {{ goal_form.title }}
                            </div>
                            <button type="button" class="remove-form-btn bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150 self-end" data-form-type="goal">
                                Remove
                            </button>
                        </div>
                        {% if goal_form.errors %}{{ goal_form.errors }}{% endif %}
                    </div>
                {% endfor %}
            </div>

            ---

            <h2 class="text-2xl font-semibold text-gray-800 mb-4 mt-6 flex justify-between items-center">
                3. Key Performance Indicators (KPIs)
                <button type="button" id="add-kpi-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                    + Add KPI
                </button>
            </h2>
            
            {{ kpi_formset.management_form }}
            <div id="kpis-container" class="space-y-4 mb-8">
                {% for kpi_form in kpi_formset %}
                    <div class="kpi-form form-row p-4 border rounded-lg bg-gray-50 shadow-sm {% if kpi_form.instance.pk and kpi_form.DELETE.value %}deleted-form{% endif %}" data-form-type="kpi">
                        <h4 class="font-medium text-lg text-gray-700 mb-2">KPI #<span class="form-number">{{ forloop.counter }}</span></h4>
                        {{ kpi_form.id }}
                        {{ kpi_form.DELETE }}
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>{{ kpi_form.name.label_tag }}{{ kpi_form.name }}</div>
                            <div>{{ kpi_form.baseline.label_tag }}{{ kpi_form.baseline }}</div>
                            <div>{{ kpi_form.target.label_tag }}{{ kpi_form.target }}</div>
                            {# Include other KPI fields here (Q1, Q2, etc.) if they exist in your formset #}
                        </div>
                        <button type="button" class="remove-form-btn bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150 mt-4" data-form-type="kpi">
                            Remove
                        </button>
                        {% if kpi_form.errors %}{{ kpi_form.errors }}{% endif %}
                    </div>
                {% endfor %}
            </div>

            ---

            {# START OF NEW NESTED STRUCTURE #}
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 mt-6 flex justify-between items-center">
                4. Major Activities & Sub-Tasks
                <button type="button" id="add-major_activities-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                    + Add Major Activity
                </button>
            </h2>
            
            {{ major_activity_formset.management_form }}
            <div id="major_activities-container" class="space-y-6 mb-8">
                {% for major_form in major_activity_formset %}
                    <div class="major_activities-form form-row p-4 border rounded-lg shadow-inner bg-yellow-50" 
                         data-form-type="major_activities" 
                         data-prefix="{{ major_activity_formset.prefix }}-{{ forloop.counter0 }}">

                        <h3 class="text-xl font-semibold mb-3 text-yellow-800 flex justify-between items-center">
                            Major Activity #<span class="form-number">{{ forloop.counter }}</span>
                            <div class="flex items-center space-x-2">
                                {{ major_form.id }}
                                <button type="button" class="remove-form-btn bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150" data-form-type="major_activities">
                                    Remove
                                </button>
                                {{ major_form.DELETE }}
                            </div>
                        </h3>
                        
                        {# Major Activity Fields #}
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div class="md:col-span-2">
                                {{ major_form.name.label_tag }}{{ major_form.name }}
                            </div>
                            <div>
                                {{ major_form.total_weight.label_tag }}{{ major_form.total_weight }}
                            </div>
                            <div>
                                {{ major_form.budget.label_tag }}{{ major_form.budget }}
                            </div>
                        </div>
                        {% if major_form.errors %}<div class="text-red-500 text-sm mt-1">{{ major_form.errors|join:", " }}</div>{% endif %}

                        {# START OF NESTED DETAIL ACTIVITIES (LEVEL 3) #}
                        <div class="nested-formset-container border-t pt-3 mt-4">
                            <h4 class="text-md font-medium mb-3 text-yellow-800">Sub-Tasks (Detail Activities)</h4>
                            
                            <div class="detail_activities-container space-y-3" id="detail_activities-{{ major_activity_formset.prefix }}-{{ forloop.counter0 }}-container">
                                {% with detail_formset=detail_activity_formset|make_detail_formset:major_form.instance %}
                                    {# CRITICAL: Management form for the nested formset #}
                                    {{ detail_formset.management_form }}
                                    
                                    {% for detail_form in detail_formset %}
                                        {% include '_detail_activity_form.html' with form=detail_form parent_prefix=major_activity_formset.prefix form_index=forloop.counter0 parent_index=forloop.parentloop.counter0 %}
                                    {% endfor %}
                                {% endwith %}
                            </div>
                            
                            <button type="button" class="add-nested-form-btn mt-3 px-3 py-1 bg-yellow-600 text-white rounded-md text-sm hover:bg-yellow-700" 
                                    data-parent-prefix="{{ major_activity_formset.prefix }}-{{ forloop.counter0 }}" 
                                    data-nested-prefix="detail_activities">
                                + Add Sub-Task
                            </button>
                        </div>
                        {# END OF NESTED DETAIL ACTIVITIES #}

                    </div>
                {% endfor %}
            </div>
            {# END OF NEW NESTED STRUCTURE #}

            ---

            <div class="mt-8 pt-4 border-t flex justify-end space-x-4">
                <a href="{% url 'view_plan' plan_instance.id %}" class="bg-gray-300 text-gray-800 text-xl font-bold px-8 py-3 rounded-xl hover:bg-gray-400 transition duration-150 shadow-lg">
                    Cancel
                </a>
                <button type="submit" class="bg-green-600 text-white text-xl font-bold px-8 py-3 rounded-xl hover:bg-green-700 transition duration-150 shadow-lg">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

{# ------------------------ TEMPLATES FOR CLONING ------------------------ #}

<template id="empty-goal-form">
    {# ... (Keep your original empty-goal-form template) ... #}
</template>

<template id="empty-kpi-form">
    {# ... (Keep your original empty-kpi-form template) ... #}
</template>

{# NEW TEMPLATE FOR MAJOR ACTIVITY (Level 2) #}
<template id="empty-major_activities-form">
    <div class="major_activities-form form-row p-4 border rounded-lg shadow-inner bg-yellow-50" 
         data-form-type="major_activities" 
         data-prefix="major_activities-__prefix__">

        <h3 class="text-xl font-semibold mb-3 text-yellow-800 flex justify-between items-center">
            Major Activity #<span class="form-number"></span>
            <div class="flex items-center space-x-2">
                {{ major_activity_formset.empty_form.id }}
                <button type="button" class="remove-form-btn bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150" data-form-type="major_activities">
                    Remove
                </button>
                {{ major_activity_formset.empty_form.DELETE }}
            </div>
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="md:col-span-2">
                {{ major_activity_formset.empty_form.name.label_tag }}{{ major_activity_formset.empty_form.name }}
            </div>
            <div>
                {{ major_activity_formset.empty_form.total_weight.label_tag }}{{ major_activity_formset.empty_form.total_weight }}
            </div>
            <div>
                {{ major_activity_formset.empty_form.budget.label_tag }}{{ major_activity_formset.empty_form.budget }}
            </div>
        </div>

        {# CRITICAL: Nested Detail Activity Management Form (prefixed for JS) #}
        <div class="nested-formset-container border-t pt-3 mt-4">
            <h4 class="text-md font-medium mb-3 text-yellow-800">Sub-Tasks (Detail Activities)</h4>
            
            <div class="detail_activities-container space-y-3" id="detail_activities-major_activities-__prefix__-container">
                {# Render the EMPTY DetailActivityFormset's management form, explicitly prefixed for JS cloning #}
                {% with nested_prefix='detail_activities-major_activities-__prefix__' %}
                    {% for field in detail_activity_formset.empty_form.management_form %}
                        <input type="{{ field.widget_type }}" name="{{ nested_prefix }}-{{ field.name|cut:'detail_activity_set-' }}" id="{{ nested_prefix }}-{{ field.name|cut:'detail_activity_set-' }}" value="{{ field.value|default:'' }}" {{ field.field.widget.attrs|join:' ' }}>
                    {% endfor %}
                {% endwith %}
            </div>
            
            <button type="button" class="add-nested-form-btn mt-3 px-3 py-1 bg-yellow-600 text-white rounded-md text-sm hover:bg-yellow-700" 
                    data-parent-prefix="major_activities-__prefix__"
                    data-nested-prefix="detail_activities">
                + Add Sub-Task
            </button>
        </div>
    </div>
</template>

{# NEW TEMPLATE FOR DETAIL ACTIVITY (Level 3) #}
<template id="empty-detail_activities-form">
    {# Include the partial template for the nested form #}
    {% include '_detail_activity_form.html' with form=detail_activity_formset.empty_form parent_prefix='major_activities-__parent_prefix__' form_index='__prefix__' parent_index='__parent_index__' %}
</template>

<template id="empty-kpi-form">
    {# ... (Keep your original empty-kpi-form template) ... #}
</template>

{# NEW TEMPLATE FOR MAJOR ACTIVITY (Level 2) #}
<template id="empty-major_activities-form">
    {# ... (Major Activity template code) ... #}
</template>

{# NEW TEMPLATE FOR DETAIL ACTIVITY (Level 3) #}
<template id="empty-detail_activities-form">
    {% include '_detail_activity_form.html' with form=detail_activity_formset.empty_form parent_prefix='major_activities-__parent_prefix__' form_index='__prefix__' parent_index='__parent_index__' %}
</template>

{# START OF YOUR ORIGINAL STYLE BLOCK (Missing in previous response snippet) #}
<style>
    /* Styling for the main form fields */
    input:not([type="checkbox"]):not([type="radio"]):not([type="submit"]), textarea, select {
        @apply block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500;
    }
    /* Visual indicator for forms marked for deletion */
    .deleted-form {
        opacity: 0.5;
        background-color: #fef2f2; /* bg-red-50 */
        border-color: #fca5a5; /* border-red-300 */
        pointer-events: auto; /* Ensure buttons still work */
    }
</style>
{# END OF STYLE BLOCK #}


<script>
    // Note: This script is modified to incorporate the nested formset logic.
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- Core Formset Manager (UNCHANGED) ---
        function FormsetManager(containerId, addBtnId, emptyFormTemplateId, prefix, formClass) {
            
            const container = document.getElementById(containerId);
            const addButton = document.getElementById(addBtnId);
            const template = document.getElementById(emptyFormTemplateId);
            const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);

            function updateFormNumbers() {
                const forms = container.querySelectorAll(`.${formClass}`);
                let visibleCount = 0;
                
                forms.forEach((form) => {
                    // Only count forms that are NOT marked for deletion
                    if (form.style.display !== 'none' && !form.classList.contains('deleted-form')) {
                        visibleCount++;
                        const numberSpan = form.querySelector('.form-number');
                        const header = form.querySelector('h3, h4');

                        if (numberSpan) {
                            numberSpan.textContent = visibleCount;
                        }
                        if (header) {
                            // Update the entire header text to ensure "Major Activity #X" updates correctly
                            let currentText = header.textContent.trim().split('#')[0];
                            let numberSpanElement = header.querySelector('.form-number');
                            if (numberSpanElement) {
                                numberSpanElement.textContent = visibleCount;
                            }
                        }
                    }
                });
            }

            container.querySelectorAll('.form-row').forEach(form => {
                 const deleteInput = form.querySelector('input[type="checkbox"][name$="-DELETE"]');
                 if (deleteInput && deleteInput.checked) {
                    form.style.display = 'none'; // Hide initially deleted forms
                    form.classList.add('deleted-form');
                 }
            });
            updateFormNumbers();

            addButton.addEventListener('click', function() {
                let currentCount = parseInt(totalFormsInput.value);
                const newFormHtml = template.innerHTML.replace(new RegExp('__prefix__', 'g'), currentCount);
                
                const newFormDiv = document.createElement('div');
                newFormDiv.innerHTML = newFormHtml.trim();
                const newForm = newFormDiv.firstChild;
                
                newForm.classList.add('form-row');
                newForm.setAttribute('data-form-type', formClass);

                container.appendChild(newForm);

                totalFormsInput.value = currentCount + 1;
                
                newForm.querySelectorAll('input:not([type="hidden"]):not([type="checkbox"]), textarea, select').forEach(input => {
                    input.value = '';
                });

                updateFormNumbers();
            });

            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-form-btn') && e.target.getAttribute('data-form-type') === formClass) {
                    const form = e.target.closest(`.${formClass}`);
                    if (!form) return;

                    const idInput = form.querySelector('input[name$="-id"]');
                    const deleteInput = form.querySelector('input[type="checkbox"][name$="-DELETE"]');

                    if (idInput && idInput.value) {
                        if (deleteInput) {
                            deleteInput.checked = true;
                        }
                        form.style.display = 'none';
                        form.classList.add('deleted-form');
                    } else {
                        form.remove();
                        totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
                    }
                    
                    updateFormNumbers();
                }
            });
        }
        // --- END Core Formset Manager ---

        // --- Nested Formset Manager Logic ---
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-nested-form-btn')) {
                const parentPrefix = e.target.getAttribute('data-parent-prefix'); // e.g., major_activities-0
                const nestedPrefix = e.target.getAttribute('data-nested-prefix'); // e.g., detail_activities
                
                const detailContainerId = `${nestedPrefix}-${parentPrefix}-container`;
                const $detailContainer = document.getElementById(detailContainerId);
                
                // The nested management form's TOTAL_FORMS field
                const $totalFormsInput = $detailContainer.querySelector(`input[name="${nestedPrefix}-${parentPrefix}-TOTAL_FORMS"]`);
                
                let currentCount = parseInt($totalFormsInput.value);

                // 1. Get the empty form HTML and replace placeholders
                let newFormHtml = document.getElementById(`empty-${nestedPrefix}-form`).innerHTML;
                
                // Replace the form index (__prefix__)
                newFormHtml = newFormHtml.replace(new RegExp('__prefix__', 'g'), currentCount);
                
                // Replace the parent prefix (__parent_prefix__)
                newFormHtml = newFormHtml.replace(new RegExp('__parent_prefix__', 'g'), parentPrefix);

                // Create and append the new form
                const newFormDiv = document.createElement('div');
                newFormDiv.innerHTML = newFormHtml.trim();
                const newForm = newFormDiv.firstChild;
                
                $detailContainer.appendChild(newForm);
                
                // 2. Increment total forms count for the nested formset
                $totalFormsInput.value = currentCount + 1;

                // 3. Clear inputs
                newForm.querySelectorAll('input:not([type="hidden"]):not([type="checkbox"]), textarea, select').forEach(input => {
                    input.value = '';
                });
            }
        });

        // Initialize top-level Formset Managers
        new FormsetManager('goals-container', 'add-goal-btn', 'empty-goal-form', '{{ goal_formset.prefix }}', 'goal-form');
        new FormsetManager('kpis-container', 'add-kpi-btn', 'empty-kpi-form', '{{ kpi_formset.prefix }}', 'kpi-form');
        
        // Initialize Major Activities (The outer part of the nested formset)
        new FormsetManager('major_activities-container', 'add-major_activities-btn', 'empty-major_activities-form', '{{ major_activity_formset.prefix }}', 'major_activities-form');
        
        // Add basic Tailwind class to the main form fields for consistency (Keep your original code)
        document.querySelectorAll('#plan-form input:not([type="hidden"]):not([type="checkbox"]):not([type="radio"]):not([type="submit"]), #plan-form textarea, #plan-form select').forEach(input => {
             if (!input.classList.contains('border')) {
                 input.classList.add('block', 'w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded-md', 'focus:ring-indigo-500', 'focus:border-indigo-500');
             }
        });

        // Initialize deletion styles for existing forms (Keep your original code)
        document.querySelectorAll('.form-row input[type="checkbox"][name$="-DELETE"]').forEach(deleteInput => {
            if (deleteInput.checked) {
                deleteInput.closest('.form-row').classList.add('deleted-form');
            }
        });

    });
</script>
{% endblock %}