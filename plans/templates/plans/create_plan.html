{% extends "plans/base.html" %}

{% block content %}
<div class="bg-white p-8 rounded-xl shadow-2xl max-w-4xl mx-auto my-10 lg:my-24">
    <h1 class="text-3xl font-bold text-center text-blue-600 mb-8">{% if form.instance.pk %}Edit Plan{% else %}Create New Plan{% endif %}</h1>
    <form id="plan-form" method="post" class="space-y-8">
        {% csrf_token %}

        <!-- Plan Details -->
        <div class="p-6 rounded-xl bg-gray-50 border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-4">Plan Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label for="{{ form.plan_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Plan Type</label>
                    {{ form.plan_type }}
                </div>
                <div>
                    <label for="{{ form.year.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                    {{ form.year }}
                </div>
                <div id="month-field" class="hidden">
                    <label for="{{ form.month.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                    {{ form.month }}
                </div>
                <div id="quarter-field" class="hidden">
                    <label for="{{ form.quarter_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Quarter</label>
                    {{ form.quarter_number }}
                </div>
                <div id="week-field" class="hidden">
                    <label for="{{ form.week_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Week</label>
                    {{ form.week_number }}
                </div>
            </div>
        </div>

        <!-- Strategic Goals Formset -->
        <div class="p-6 rounded-xl bg-gray-50 border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mt-2 mb-4">Strategic Goals</h2>
            {{ goal_formset.management_form }}
            <div id="goal-formset-container" class="space-y-4" data-form-type="goal" data-prefix="{{ goal_formset.prefix }}">
                {% for goal_form in goal_formset %}
                    <div class="form-row border p-4 rounded-md bg-gray-100 flex flex-col space-y-4 relative transition-all duration-300 ease-in-out {% if goal_form.instance.pk and goal_form.DELETE.value %}deleted-form{% endif %}">
                        
                        <!-- UNIFIED REMOVAL BUTTON -->
                        <div class="absolute top-2 right-2">
                            <!-- Hidden DELETE field for existing forms -->
                            {% if goal_form.DELETE %}{{ goal_form.DELETE }}{% endif %}

                            <!-- The consistent 'X' button for all forms -->
                            <button type="button" class="plan-form-remove-btn p-1 text-red-500 hover:text-red-700 transition-colors"
                                    title="Remove this item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        {{ goal_form.id }}
                        <div>
                            <label for="{{ goal_form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Goal Title</label>
                            {{ goal_form.title }}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- HIDDEN TEMPLATE FOR NEW GOAL FORMS (Uses __prefix__) -->
            <div id="empty-form-goal" class="hidden">
                <div class="form-row border p-4 rounded-md bg-gray-100 flex flex-col space-y-4 relative transition-all duration-300 ease-in-out">
                    <!-- UNIFIED REMOVAL BUTTON -->
                    <div class="absolute top-2 right-2">
                        {{ goal_formset.empty_form.DELETE }}
                        <button type="button" class="plan-form-remove-btn p-1 text-red-500 hover:text-red-700 transition-colors" title="Remove this item">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    {{ goal_formset.empty_form.id }}
                    <div>
                        <label for="{{ goal_formset.empty_form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Goal Title</label>
                        {{ goal_formset.empty_form.title }}
                    </div>
                </div>
            </div>
            <!-- End Hidden Template -->

            <button type="button" id="add-goal-button" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-md">
                Add Another Strategic Goal
            </button>
        </div>

        <!-- Key Performance Indicators (KPIs) Formset -->
        <div class="p-6 rounded-xl bg-gray-50 border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mt-2 mb-4">Key Performance Indicators (KPIs)</h2>
            {{ kpi_formset.management_form }}
            <div id="kpi-formset-container" class="space-y-4" data-form-type="kpi" data-prefix="{{ kpi_formset.prefix }}">
                {% for kpi_form in kpi_formset %}
                    <div class="form-row border p-4 rounded-md bg-gray-100 flex flex-col space-y-4 relative transition-all duration-300 ease-in-out {% if kpi_form.instance.pk and kpi_form.DELETE.value %}deleted-form{% endif %}">
                        
                        <!-- UNIFIED REMOVAL BUTTON -->
                        <div class="absolute top-2 right-2">
                            {% if kpi_form.DELETE %}{{ kpi_form.DELETE }}{% endif %}
                            <button type="button" class="plan-form-remove-btn p-1 text-red-500 hover:text-red-700 transition-colors"
                                    title="Remove this item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        {{ kpi_form.id }}
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="{{ kpi_form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">KPI Name</label>
                                {{ kpi_form.name }}
                            </div>
                            <div>
                                <label for="{{ kpi_form.baseline.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Baseline</label>
                                {{ kpi_form.baseline }}
                            </div>
                            <div>
                                <label for="{{ kpi_form.target.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Target</label>
                                {{ kpi_form.target }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- HIDDEN TEMPLATE FOR NEW KPI FORMS (Uses __prefix__) -->
            <div id="empty-form-kpi" class="hidden">
                <div class="form-row border p-4 rounded-md bg-gray-100 flex flex-col space-y-4 relative transition-all duration-300 ease-in-out">
                    <!-- UNIFIED REMOVAL BUTTON -->
                    <div class="absolute top-2 right-2">
                        {{ kpi_formset.empty_form.DELETE }}
                        <button type="button" class="plan-form-remove-btn p-1 text-red-500 hover:text-red-700 transition-colors" title="Remove this item">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    {{ kpi_formset.empty_form.id }}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="{{ kpi_formset.empty_form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">KPI Name</label>
                            {{ kpi_formset.empty_form.name }}
                        </div>
                        <div>
                            <label for="{{ kpi_formset.empty_form.baseline.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Baseline</label>
                            {{ kpi_formset.empty_form.baseline }}
                        </div>
                        <div>
                            <label for="{{ kpi_formset.empty_form.target.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Target</label>
                            {{ kpi_formset.empty_form.target }}
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Hidden Template -->

            <button type="button" id="add-kpi-button" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-md">
                Add Another KPI
            </button>
        </div>

        <!-- Activities Formset -->
        <div class="p-6 rounded-xl bg-gray-50 border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mt-2 mb-4">Activities</h2>
            {{ activity_formset.management_form }}
            <div id="activity-formset-container" class="space-y-4" data-form-type="activity" data-prefix="{{ activity_formset.prefix }}">
                {% for activity_form in activity_formset %}
                    <div class="form-row border p-4 rounded-md bg-gray-100 flex flex-col space-y-4 relative transition-all duration-300 ease-in-out {% if activity_form.instance.pk and activity_form.DELETE.value %}deleted-form{% endif %}">
                        
                        <!-- UNIFIED REMOVAL BUTTON -->
                        <div class="absolute top-2 right-2">
                            {% if activity_form.DELETE %}{{ activity_form.DELETE }}{% endif %}
                            <button type="button" class="plan-form-remove-btn p-1 text-red-500 hover:text-red-700 transition-colors"
                                    title="Remove this item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        {{ activity_form.id }}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="{{ activity_form.major_activity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Major Activity</label>
                                {{ activity_form.major_activity }}
                            </div>
                            <div>
                                <label for="{{ activity_form.responsible_person.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Responsible Person</label>
                                {{ activity_form.responsible_person }}
                            </div>
                        </div>
                        <div>
                            <label for="{{ activity_form.detail_activity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Detailed Steps</label>
                            {{ activity_form.detail_activity }}
                        </div>
                        <div>
                            <label for="{{ activity_form.budget.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Budget</label>
                            {{ activity_form.budget }}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- HIDDEN TEMPLATE FOR NEW ACTIVITY FORMS (Uses __prefix__) -->
            <div id="empty-form-activity" class="hidden">
                <div class="form-row border p-4 rounded-md bg-gray-100 flex flex-col space-y-4 relative transition-all duration-300 ease-in-out">
                    <!-- UNIFIED REMOVAL BUTTON -->
                    <div class="absolute top-2 right-2">
                        {{ activity_formset.empty_form.DELETE }}
                        <button type="button" class="plan-form-remove-btn p-1 text-red-500 hover:text-red-700 transition-colors" title="Remove this item">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    {{ activity_formset.empty_form.id }}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="{{ activity_formset.empty_form.major_activity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Major Activity</label>
                            {{ activity_formset.empty_form.major_activity }}
                        </div>
                        <div>
                            <label for="{{ activity_formset.empty_form.responsible_person.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Responsible Person</label>
                            {{ activity_formset.empty_form.responsible_person }}
                        </div>
                    </div>
                    <div>
                        <label for="{{ activity_formset.empty_form.detail_activity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Detailed Steps</label>
                        {{ activity_formset.empty_form.detail_activity }}
                    </div>
                    <div>
                        <label for="{{ activity_formset.empty_form.budget.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Budget</label>
                        {{ activity_formset.empty_form.budget }}
                    </div>
                </div>
            </div>
            <!-- End Hidden Template -->

            <button type="button" id="add-activity-button" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-md">
                Add Another Activity
            </button>
        </div>
        
        <div class="flex justify-center items-center pt-8 border-t space-x-4">
            <button type="submit" class="bg-blue-600 text-white py-3 px-12 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-lg">
                {% if form.instance.pk %}Save Changes{% else %}Create Plan{% endif %}
            </button>
            <a href="{% url 'dashboard' %}" class="cancel-link bg-gray-300 text-gray-800 py-3 px-12 rounded-lg font-bold hover:bg-gray-400 transition-colors shadow-lg">Cancel</a>
        </div>
    </form>
</div>

<style>
    /* Styling for form fields */
    input, textarea, select {
        @apply block w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500;
    }

    /* Styling for deleted form rows */
    .deleted-form {
        opacity: 0.5;
        background-color: #fee2e2; /* bg-red-100 */
        border-color: #fca5a5; /* border-red-300 */
        /* Re-enable pointer events for the form row, but the button handles the deletion */
        pointer-events: auto; 
    }
    .deleted-form .plan-form-remove-btn {
        color: #ef4444 !important; /* text-red-500 - ensures the X is visible */
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- Formset Management Functions ---

        // Function to re-index all remaining forms in a container
        function reindexForms(container) {
            const prefix = container.dataset.prefix;
            const formRows = container.querySelectorAll('.form-row');
            
            formRows.forEach((row, index) => {
                const oldPrefix = `${prefix}-\\d+`;
                const newPrefix = `${prefix}-${index}`;
                const regex = new RegExp(oldPrefix, 'g');

                // Helper to update attributes
                const updateAttr = (elem, attr) => {
                    const oldValue = elem.getAttribute(attr);
                    if (oldValue) {
                        elem.setAttribute(attr, oldValue.replace(regex, newPrefix));
                    }
                };

                row.querySelectorAll('[name]').forEach(elem => {
                    updateAttr(elem, 'name');
                });
                row.querySelectorAll('[id]').forEach(elem => {
                    updateAttr(elem, 'id');
                });
                row.querySelectorAll('[for]').forEach(elem => {
                    updateAttr(elem, 'for');
                });
            });

            // Update TOTAL_FORMS field
            const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
            if (totalFormsInput) {
                totalFormsInput.value = formRows.length;
            }
        }
        
        // Function to handle dynamic form additions (Updated to use hidden empty forms)
        function addForm(containerId) {
            const container = document.getElementById(containerId);
            const formType = container.dataset.formType; // e.g., 'goal'
            const prefix = container.dataset.prefix; // e.g., 'goals'
            const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
            let totalForms = parseInt(totalFormsInput.value);

            // 1. Get the template from the hidden div
            const emptyFormTemplate = document.getElementById(`empty-form-${formType}`);
            if (!emptyFormTemplate) {
                console.error(`Error: Could not find empty form template for ${formType}.`);
                return;
            }
            
            // 2. Clone the content and replace '__prefix__'
            const templateHtml = emptyFormTemplate.innerHTML;
            // The template uses '__prefix__', replace it with the current totalForms count
            const newFormHtml = templateHtml.replace(/__prefix__/g, totalForms);
            
            // 3. Create the new form element
            const newFormWrapper = document.createElement('div');
            newFormWrapper.innerHTML = newFormHtml.trim();
            const newFormRow = newFormWrapper.firstElementChild; // The actual form-row div
            
            // 4. Attach listener to the new remove button
            const removeButton = newFormRow.querySelector('.plan-form-remove-btn');
            if (removeButton) {
                removeButton.addEventListener('click', handleRemoveClick);
            }
            
            // 5. Append the new form and update total forms
            container.appendChild(newFormRow);
            totalFormsInput.value = totalForms + 1;
        }

        // UNIFIED removal handler
        function handleRemoveClick(event) {
            const button = event.currentTarget;
            const formRow = button.closest('.form-row');
            if (!formRow) return;

            const container = formRow.closest('div[data-form-type]');
            if (!container) return;

            const deleteCheckbox = formRow.querySelector('input[type="hidden"][name$="-DELETE"]');
            const primaryKeyInput = formRow.querySelector('input[type="hidden"][name$="-id"]');

            // Determine if this is an existing form (has a PK) or a new form
            const isExistingForm = primaryKeyInput && primaryKeyInput.value;

            if (isExistingForm && deleteCheckbox) {
                // Case 1: Existing form (Edit scenario) - Toggle the hidden DELETE checkbox
                deleteCheckbox.value = deleteCheckbox.value === 'on' ? '' : 'on'; // Toggle 'on' or empty
                formRow.classList.toggle('deleted-form', deleteCheckbox.value === 'on');
            } else {
                // Case 2: New form (no PK) - Physically remove
                formRow.remove();
                // Re-index the remaining forms to maintain correct management_form counts
                reindexForms(container);
            }
        }
        
        // --- Initialization and Event Listeners ---

        // 1. Add event listeners for the "Add" buttons
        document.getElementById('add-goal-button').addEventListener('click', () => {
            addForm('goal-formset-container');
        });
        document.getElementById('add-kpi-button').addEventListener('click', () => {
            addForm('kpi-formset-container');
        });
        document.getElementById('add-activity-button').addEventListener('click', () => {
            addForm('activity-formset-container');
        });

        // 2. Add event listeners for the unified "Remove" buttons
        document.querySelectorAll('.plan-form-remove-btn').forEach(button => {
            button.addEventListener('click', handleRemoveClick);
        });

        // 3. Plan Type conditional visibility
        const planTypeSelect = document.getElementById('id_plan_type');
        const monthField = document.getElementById('month-field');
        const quarterField = document.getElementById('quarter-field');
        const weekField = document.getElementById('week-field');

        function updatePlanFields() {
            const planType = planTypeSelect.value;
            // Hide all first
            [monthField, quarterField, weekField].forEach(f => f.classList.add('hidden'));

            // Show relevant fields
            if (planType === 'monthly') {
                monthField.classList.remove('hidden');
            } else if (planType === 'quarterly') {
                quarterField.classList.remove('hidden');
            } else if (planType === 'weekly') {
                monthField.classList.remove('hidden'); // Weeks often depend on the month
                weekField.classList.remove('hidden');
            }
        }

        planTypeSelect.addEventListener('change', updatePlanFields);
        updatePlanFields(); // Call on page load
    });
</script>
{% endblock %}
