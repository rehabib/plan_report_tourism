<div class="detail_activities-form form-row p-3 border border-yellow-200 rounded-md bg-white shadow-sm ml-4 {% if form.instance.pk and form.DELETE.value %}deleted-form{% endif %}">
    
    {# 1. Hidden Fields and Management Data #}
    {{ form.id }}
    {{ form.DELETE }}
    
    {# CRITICAL: The hidden field linking back to the parent MajorActivity instance. #}
    {# The name attribute is set by the custom tag/view and needs to be dynamic. #}
    {% if form.instance.major_activity_id %}
        {# For existing forms, use the original field name #}
        {{ form.major_activity }} 
    {% else %}
        {# For new forms, the name needs the full prefix for Django to match it on the MajorActivity formset instance #}
        {% with major_activity_field_name=form.major_activity.name|cut:'detail_activity_set-' %}
             <input type="hidden" name="{{ parent_prefix }}-{{ form_index }}-{{ major_activity_field_name }}" id="id_{{ parent_prefix }}-{{ form_index }}-{{ major_activity_field_name }}" value="">
        {% endwith %}
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-center">
        {# 2. Detail Activity Name/Description (Col-span 2) #}
        <div class="md:col-span-1">
             {{ form.name.label_tag }}
             {{ form.name }}
        </div>

        {# 3. Detail Activity Weight #}
        <div>
             {{ form.weight.label_tag }}
             {{ form.weight }}
        </div>
        
        {# 4. Responsible Person #}
        <div>
             {{ form.responsible_person.label_tag }}
             {{ form.responsible_person }}
        </div>

        {# 5. Remove Button #}
        <div class="self-end pt-5">
            <button type="button" class="remove-nested-form-btn bg-red-400 text-white px-2 py-2 rounded-lg hover:bg-red-500 transition duration-150 w-full text-sm">
                Remove Task
            </button>
        </div>
    </div>
    
    {% if form.errors %}
        <div class="text-red-500 text-xs mt-1">{{ form.errors|join:", " }}</div>
    {% endif %}

</div>